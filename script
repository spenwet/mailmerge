//The following script was modified from that provided by Danny Blaker at http://www.dannyblaker.com/fishinfordham/autofill-a-template-from-a-google-sheet-and-email-as-a-pdf-using-google-scripts


function onOpen() {
  var menuEntries = [ {name: "Create Autofilled Template", functionName: "AutofillDocFromTemplate"}];
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  ss.addMenu("Create", menuEntries);
}

function AutofillDocFromTemplate(){
  var templateid = "XXXX FILL XXXX"; // TODO: Fill in your template doc ID
  var FOLDER_NAME = "Output Folder"; // TODO: Fill in name of destination folder
  
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getActiveSheet();
  var data = sheet.getRange(2, 1, sheet.getLastRow()-1, sheet.getLastColumn()).getValues();
 
  for (var i in data){
    var row = data[i];
    var usernamefordoctitle = sheet.getRange(2, 1, 1, 1).getValues(); 
    var newDoc = DocumentApp.create("Template for " +row[0]);
    var file = DriveApp.getFileById(newDoc.getId());
    var folder = DriveApp.getFolderById("XXXX FILL IN XXXX"); // TODO: Fill in folder ID
    folder.addFile(file)
  
    
    var docid = DriveApp.getFileById(templateid).makeCopy().getId();
    var doc = DocumentApp.openById(docid);
    var body = doc.getActiveSection();
    body.replaceText("%NAME%", row[0]);
    body.replaceText("%EMAIL%", row[1]);
    body.replaceText("%LICENSE%", row[2]); // To add more auto gen fields, add them below along with the column number
    
    appendToDoc(doc, newDoc);
    
    doc.saveAndClose()
    newDoc.saveAndClose()
    var message = "Dear "+row[0]+",\n\nAttached is an automatically generated document.\n\nPlease contact us with any questions."; // Message for email body
    var emailTo = row[1]; // replace with your email
    var subject = "Generated Document"; // customize subject 
    var pdf = DriveApp.getFileById(newDoc.getId()).getAs('application/pdf').getBytes();
    var attach = {fileName:'AutomatedDoc.pdf',content:pdf, mimeType:'application/pdf'}; // customize file name: "Autogenerated template"
    MailApp.sendEmail(emailTo, subject, message, {attachments:[attach]});
    
    DriveApp.getFileById(docid).setTrashed(true);
    
  }
  ss.toast("Template has been complied. It worked. it's alive. IT'S ALIVE!!");
}

function appendToDoc(src, dst) {
  for (var i = 0; i < src.getNumChildren(); i++) {
    appendElementToDoc(dst, src.getChild(i));
  }
}

function appendElementToDoc(doc, object) {
  var type = object.getType();
  var element = object.removeFromParent();
  Logger.log("Element type is "+type);
  if (type == "PARAGRAPH") {
    doc.appendParagraph(element);
  } else if (type == "TABLE") {
    doc.appendTable(element);
  } 
}
